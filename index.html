<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Bot Test Page (Interactive with Modals)</title>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <style>
        body { font-family: sans-serif; background-color: #1a1a2e; color: #e0e0e0; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; text-align: center; overflow: hidden; }
        .container { background-color: #16213e; padding: 30px; border-radius: 15px; box-shadow: 0 0 20px rgba(0,0,0,0.5); width: 90%; max-width: 800px; position: relative; } /* Added position: relative for modals */

        /* Styles for Steps content within step-container */
        .step-content {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .step-content.visible {
            opacity: 1;
            transform: translateY(0);
        }

        h2 { color: #e94560; }
        button, .branch-item, .MuiPickersDay-root, .timeButtons { background-color: #533483; color: white; border: none; padding: 10px 15px; margin: 5px; border-radius: 8px; cursor: pointer; font-size: 14px; transition: background-color 0.3s; }
        .selected, .clicked { background-color: #e94560; box-shadow: 0 0 10px #e94560; }
        .branch-item.is_full, .MuiPickersDay-root.Mui-disabled, .timeButtons.disabledTime { background-color: #444; color: #888; cursor: not-allowed; }
        
        button.register, button.next-btn { background-color: #888; color: #ccc; cursor: not-allowed; transition: background-color 0.5s ease; }
        button.register.enabled, button.next-btn.enabled { background-color: #28a745; color: white; cursor: pointer; }

        button:disabled { background-color: #888; color: #ccc; cursor: not-allowed; opacity: 0.7; }
        .grid-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; }
        #countdown-text { color: #e94560; font-size: 18px; margin-top: 20px; }
        .summary-info { background-color: #1a1a2e; padding: 15px; border-radius: 8px; margin: 20px 0; text-align: left; }
        .summary-info p { margin: 8px 0; font-size: 16px; }
        .summary-info span { color: #e94560; font-weight: bold; }
        .checkbox-container { margin: 20px 0; display: flex; justify-content: center; align-items: center; gap: 10px; }
        #cloudflare-check { display: none; align-items: center; justify-content: center; gap: 10px; margin: 20px 0; font-size: 16px; }
        .spinner { width: 24px; height: 24px; border: 3px solid #533483; border-top-color: #e94560; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #success-popup { background-color: #1e1e2e; border: 1px solid #e94560; padding: 20px; margin-top: 20px; border-radius: 10px; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10000; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #16213e;
            margin: auto;
            padding: 30px;
            border: 1px solid #888;
            border-radius: 15px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            position: relative;
        }
        .modal-content h2 { margin-top: 0; }
        .modal-content .close {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-content .close:hover,
        .modal-content .close:focus {
            color: #e94560;
            text-decoration: none;
            cursor: pointer;
        }
        .branchButtons, #dateList, #timeList {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            max-height: 400px; /* Limit height for scroll */
            overflow-y: auto; /* Enable scroll for many items */
            padding-right: 10px; /* Space for scrollbar */
        }
        .branch-item, .MuiPickersDay-root, .timeButtons {
            flex-grow: 1; /* Allow items to grow */
            text-align: center;
            min-width: 80px; /* Minimum width for buttons */
        }
        .modal .next-btn {
            margin-top: 20px;
            padding: 12px 25px;
            font-size: 16px;
            width: 100%; /* Full width in modal */
        }
        .center-text-btn { /* for datetime modal confirm button */
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
    </style>
</head>
<body>
    <div id="main-container" class="container hidden">
        <div id="step-container">
            </div>
    </div>

    <div id="branchModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Select Branch</h2>
            <div id="branchList"></div>
            </div>
    </div>

    <div id="datetimeModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Select Date & Time</h2>
            <h3>Date:</h3>
            <div id="dateList" class="grid-container"></div>
            <h3>Time:</h3>
            <div id="timeList" class="grid-container"></div>
            </div>
    </div>

    <div id="enable-bot-prompt" class="container">
        <h2>Please Enable DPbot Extension</h2>
        <p>This test page requires the DPbot extension to be active.</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <script>
        let currentStep = 0;
        const maxStep = 4;
        let captchaPassed = false;
        let selections = { branch: null, date: null, time: null }; // Global selections object
        let startTime; // To track elapsed time

        // This replaces the individual 'page-x' divs and `showPage` logic
        async function loadStep(step) {
            if (step > maxStep) return;

            // Simulate fetching HTML for each step
            let htmlContent = '';
            if (step === 0) {
                htmlContent = `
                    <div class="step-content">
                        <h2>Welcome to DPbot Test Rocket</h2>
                        <p id="countdown-text">Register button will be active in <span id="countdown">5</span>s</p>
                        <button id="registerBtn" class="register" disabled>Register</button>
                    </div>
                `;
            } else if (step === 1) { // Branch selection, handled by modal. This step is a placeholder for flow
                 // This step won't display content directly, it will trigger the modal
            } else if (step === 2) { // Date/Time selection, handled by modal. This step is a placeholder for flow
                 // This step won't display content directly, it will trigger the modal
            } else if (step === 3) {
                htmlContent = `
                    <div class="step-content">
                        <h2>Booking Summary</h2>
                        <div class="summary-info">
                            <p>Branch: <span id="summary-branch">${selections.branch || 'N/A'}</span></p>
                            <p>Date: <span id="summary-date">${selections.date || 'N/A'}</span></p>
                            <p>Time: <span id="summary-time">${selections.time || 'N/A'}</span></p>
                        </div>
                        <div class="checkbox-container">
                            <input type="checkbox" id="terms-checkbox" name="acceptTermsAndConditions">
                            <label for="terms-checkbox">I accept the terms and conditions</label>
                        </div>
                        <div id="cloudflare-check" style="display: none;"><div class="spinner"></div><span>Verifying your browser...</span></div>
                        <button id="finalConfirm" class="next-btn" disabled>Confirm Booking</button>
                    </div>
                `;
            } else if (step === 4) {
                 htmlContent = `
                    <div class="step-content">
                        <h2>Confirm Final Booking</h2>
                        <div class="summary-info">
                            <p>Branch: <span id="confirm-summary-branch">${selections.branch || 'N/A'}</span></p>
                            <p>Date: <span id="confirm-summary-date">${selections.date || 'N/A'}</span></p>
                            <p>Time: <span id="confirm-summary-time">${selections.time || 'N/A'}</span></p>
                        </div>
                        <div class="checkbox-container">
                            <input type="checkbox" name="acceptTermsAndConditions" id="confirmTermsCheckbox">
                            <label for="confirmTermsCheckbox">I accept the terms and conditions</label>
                        </div>
                        <div class="cf-turnstile" data-sitekey="0x4AAAAAABh0BOjMe3Fn3FMt" data-theme="dark"></div>
                        <button id="confirmBtn" class="next-btn" disabled>Confirm Booking</button>
                    </div>
                `;
            } else if (step === 5) { // Success step
                const endTime = new Date();
                const elapsedTime = ((endTime - startTime) / 1000).toFixed(2);
                htmlContent = `
                    <div class="step-content">
                        <h2 style="font-size: 28px; color: #28a745;">Booking Successful!</h2>
                        <div id="success-popup" class="summary-info">
                            <h3>Your Booking Details</h3>
                            <p>Branch: <span id="final-summary-branch">${selections.branch}</span></p>
                            <p>Date: <span id="final-summary-date">${selections.date}</span></p>
                            <p>Time: <span id="final-summary-time">${selections.time}</span></p>
                            <p>Total Time: <span id="final-summary-elapsed">${elapsedTime}</span> seconds</p>
                        </div>
                        <button onclick="resetTest()">Run Again</button>
                    </div>
                `;
            }


            const container = document.getElementById("step-container");
            container.innerHTML = htmlContent;

            const content = container.querySelector(".step-content");
            if (content) {
                setTimeout(() => content.classList.add("visible"), 50);
            }

            if (step === 0) {
                startTime = new Date(); // Start timing from step 0
                const countdownEl = document.getElementById("countdown");
                const registerBtn = document.getElementById("registerBtn");
                let secondsLeft = 5;
                const timer = setInterval(() => {
                    if (secondsLeft <= 0) {
                        clearInterval(timer);
                        countdownEl.textContent = "เปิดแล้ว!";
                        registerBtn.disabled = false;
                        registerBtn.classList.add("enabled"); // Add enabled class for styling
                    } else {
                        countdownEl.textContent = `${String(Math.floor(secondsLeft / 60)).padStart(2, '0')}:${String(secondsLeft % 60).padStart(2, '0')}`;
                        secondsLeft--;
                    }
                }, 1000);
                registerBtn.addEventListener("click", () => {
                    openBranchModal();
                });
            }

            if (step === 3) {
                const termsCheckbox = document.getElementById('terms-checkbox');
                const cloudflareCheck = document.getElementById('cloudflare-check');
                const finalConfirm = document.getElementById("finalConfirm"); // Changed from finalConfirmBtn

                if (termsCheckbox && finalConfirm) {
                    finalConfirm.disabled = true; // Initially disabled

                    termsCheckbox.addEventListener('change', () => {
                        if (termsCheckbox.checked) {
                            cloudflareCheck.style.display = 'flex';
                            setTimeout(() => {
                                cloudflareCheck.style.display = 'none';
                                finalConfirm.disabled = false;
                                finalConfirm.classList.add('enabled');
                            }, 3000);
                        } else {
                            finalConfirm.disabled = true;
                            finalConfirm.classList.remove('enabled');
                            cloudflareCheck.style.display = 'none';
                        }
                    });

                    finalConfirm.addEventListener("click", () => {
                        if (!finalConfirm.disabled) {
                            currentStep = 4;
                            loadStep(currentStep);
                        }
                    });
                }
            }


            if (step === 4) {
                const confirmBookingBtn = document.getElementById("confirmBtn");
                const checkbox = document.getElementById("confirmTermsCheckbox"); // Use specific ID for step 4 checkbox

                if (typeof turnstile !== 'undefined') {
                    const tsDiv = document.querySelector('.cf-turnstile');
                    if (tsDiv) {
                        turnstile.render(tsDiv, {
                            sitekey: '0x4AAAAAABh0BOjMe3Fn3FMt', // This is a dummy sitekey for demonstration
                            theme: 'dark',
                            callback: onCaptchaSuccess
                        });
                    }
                }

                if (checkbox && confirmBookingBtn) {
                    confirmBookingBtn.disabled = true; // Disable until conditions met

                    // Initial check
                    confirmBookingBtn.disabled = !(checkbox.checked && captchaPassed);

                    checkbox.addEventListener("change", () => {
                        confirmBookingBtn.disabled = !(checkbox.checked && captchaPassed);
                    });

                    confirmBookingBtn.addEventListener("click", (e) => {
                        e.preventDefault();
                        if (!confirmBookingBtn.disabled) {
                            // Proceed to final success page (step 5)
                            currentStep = 5;
                            loadStep(currentStep);
                            launchConfetti();
                        }
                    });
                }
            }
        }

        function openBranchModal() {
            const modal = document.getElementById("branchModal");
            const closeBtn = modal.querySelector(".close");
            const list = modal.querySelector("#branchList");
            modal.style.display = "flex"; // Use flex to center content
            
            closeBtn.onclick = () => { modal.style.display = "none"; };

            // Randomize availability for branches
            list.innerHTML = ""; // Clear before adding new branches

            const branches = ["Terminal 21", "Central Ladprao", "Siam Center", "Fashion Island", "Centralworld",
                "MEGABANGNA", "Siam Square", "Emsphere", "Central Pattaya", "Seacon Square",
                "Central Westgate", "Central Chiangmai", "Icon Siam"
            ];
            const branchesToMakeFull = Math.floor(Math.random() * 2) + 1; // 1 or 2 branches full
            let shuffledBranches = [...branches].sort(() => 0.5 - Math.random());
            let fullBranches = shuffledBranches.slice(0, branchesToMakeFull);

            let selectedBranchItem = null; // To track the currently selected element

            const nextBtn = document.createElement("button");
            nextBtn.textContent = "Next";
            nextBtn.className = "next-btn";
            nextBtn.disabled = true;
            nextBtn.onclick = () => {
                modal.style.display = "none";
                currentStep = 2; // Move to date/time selection step
                openDateTimeModal();
            };

            branches.forEach(b => {
                const div = document.createElement("div");
                div.className = "branch-item";
                const isFull = fullBranches.includes(b);
                if (isFull) {
                    div.classList.add("is_full");
                    div.textContent = b + " (Full)";
                } else {
                    div.textContent = b;
                }
                
                div.onclick = () => {
                    if (isFull) return; // Do nothing if branch is full
                    if (selectedBranchItem) {
                        selectedBranchItem.classList.remove("selected");
                    }
                    div.classList.add("selected");
                    selectedBranchItem = div;
                    selections.branch = b; // Store selected branch
                    nextBtn.disabled = false;
                    nextBtn.classList.add('enabled');
                };
                list.appendChild(div);
            });

            // Append next button
            list.appendChild(nextBtn);
        }

        function openDateTimeModal() {
            const modal = document.getElementById("datetimeModal");
            const closeBtn = modal.querySelector(".close");
            const dateList = modal.querySelector("#dateList");
            const timeList = modal.querySelector("#timeList");
            modal.style.display = "flex"; // Use flex to center content
            closeBtn.onclick = () => { modal.style.display = "none"; };

            const dates = Array.from({ length: 31 }, (_, i) => i + 1);
            const times = [
                "10:00", "10:30", "11:00", "11:30", "12:00", "12:30", "13:00", "13:30", "14:00", "14:30",
                "15:00", "15:30", "16:00", "16:30", "17:00", "17:30", "18:00", "18:30", "19:00", "19:30",
                "20:00", "20:30" // Removed 21:00, 21:30, 22:00, 22:30 to match original time list
            ];

            dateList.innerHTML = "";
            timeList.innerHTML = "";

            let selectedDateElement = null;
            let selectedTimeElement = null;

            // Dates - Randomize disabled days
            const dayButtonsArray = [];
            for (let i = 1; i <= 31; i++) {
                const btn = document.createElement("button");
                btn.className = "MuiPickersDay-root"; // Used MuiPickersDay-root as per original CSS
                btn.textContent = i;
                dayButtonsArray.push(btn); // Store for random disabling
                dateList.appendChild(btn);
            }

            const daysToDisable = Math.floor(Math.random() * 2) + 1; // 1 or 2 days disabled
            let shuffledDates = [...dayButtonsArray].sort(() => 0.5 - Math.random());
            for (let i = 0; i < daysToDisable; i++) {
                shuffledDates[i].classList.add('Mui-disabled');
            }


            dayButtonsArray.forEach(btn => {
                btn.onclick = () => {
                    if (btn.classList.contains('Mui-disabled')) return;
                    if (selectedDateElement) {
                        selectedDateElement.classList.remove("selected"); // Use "selected" for consistency
                    }
                    btn.classList.add("selected");
                    selectedDateElement = btn;
                    selections.date = btn.textContent; // Store selected date
                    checkDateTimeValid();
                };
            });

            // Times - Randomize disabled times
            const timeButtonsArray = [];
            times.forEach(t => {
                const btn = document.createElement("button");
                btn.className = "timeButtons";
                btn.textContent = t;
                timeButtonsArray.push(btn); // Store for random disabling
                timeList.appendChild(btn);
            });

            const timesToDisable = Math.floor(Math.random() * 2) + 1; // 1 or 2 times disabled
            let shuffledTimes = [...timeButtonsArray].sort(() => 0.5 - Math.random());
            for (let i = 0; i < timesToDisable; i++) {
                shuffledTimes[i].classList.add('disabledTime');
                shuffledTimes[i].textContent += ' (Full)';
            }


            timeButtonsArray.forEach(btn => {
                btn.onclick = () => {
                    if (btn.classList.contains('disabledTime')) return;
                    if (selectedTimeElement) {
                        selectedTimeElement.classList.remove("selected"); // Use "selected" for consistency
                    }
                    btn.classList.add("selected");
                    selectedTimeElement = btn;
                    selections.time = btn.textContent.replace(' (Full)', '').trim(); // Store selected time
                    checkDateTimeValid();
                };
            });

            const confirmBtn = document.createElement("button");
            confirmBtn.className = "next-btn center-text-btn";
            confirmBtn.textContent = "Confirm";
            confirmBtn.disabled = true;
            confirmBtn.onclick = () => {
                modal.style.display = "none";
                currentStep = 3; // Move to summary step
                loadStep(currentStep);
            };
            timeList.parentElement.appendChild(confirmBtn); // Append after timeList

            function checkDateTimeValid() {
                if (selectedDateElement && selectedTimeElement) {
                    confirmBtn.disabled = false;
                    confirmBtn.classList.add('enabled');
                } else {
                    confirmBtn.disabled = true;
                    confirmBtn.classList.remove('enabled');
                }
            }
        }

        function launchConfetti() {
            const duration = 2 * 1000;
            const end = Date.now() + duration;

            (function frame() {
                confetti({
                    particleCount: 5,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0 },
                });
                confetti({
                    particleCount: 5,
                    angle: 120,
                    spread: 55,
                    origin: { x: 1 },
                });

                if (Date.now() < end) {
                    requestAnimationFrame(frame);
                }
            })();
        }

        // Modified to fit the success page
        function showSuccessPopup(message = "Booking Success!") {
            // No longer creating a separate popup, directly updating the success page content
            // The success message is now part of step 5 HTML content
        }

        function onCaptchaSuccess(token) {
            captchaPassed = true;
            const checkbox = document.getElementById("confirmTermsCheckbox"); // Specific checkbox for step 4
            const confirmBtn = document.getElementById("confirmBtn");

            if (checkbox && checkbox.checked) {
                confirmBtn.disabled = false;
                confirmBtn.classList.add('enabled');
            }
        }

        window.resetTest = function() {
            currentStep = 0;
            captchaPassed = false;
            selections = { branch: null, date: null, time: null }; // Reset selections
            loadStep(currentStep); // Restart the process
        }

        const mainContainer = document.getElementById('main-container');
        const enableBotPrompt = document.getElementById('enable-bot-prompt');

        const checkForBot = setInterval(() => {
            if (document.body.dataset.dpbotEnabled === 'true') {
                clearInterval(checkForBot);
                enableBotPrompt.classList.add('hidden');
                mainContainer.classList.remove('hidden');
                loadStep(currentStep); // Load initial step
            }
        }, 500);
    </script>
</body>
</html>