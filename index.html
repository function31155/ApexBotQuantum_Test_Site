<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Web Test Booking - ApexBot Quantum</title>
    <style>
        /* ... CSS ทั้งหมดเหมือนเดิมทุกประการ ... */
        #captcha3dModal .modal-content { padding: 30px; background-color: #1a1e2a; border: 1px solid rgba(0, 191, 255, 0.5); box-shadow: 0 0 30px rgba(0, 191, 255, 0.3); }
        #captcha3dModal .modal-title { color: #00e0ff; font-size: 28px; text-shadow: 0 0 12px rgba(0, 224, 255, 0.8); margin-bottom: 10px; }
        #captcha3dModal .modal-content > p { font-size: 16px; color: #b0c4de; margin-bottom: 25px; text-align: center; }
        #captcha3dModal .modal-content > .sub-instruction { font-size: 13px; color: #88a0c0; margin-top: -15px; margin-bottom: 20px; line-height: 1.4; }
        #captchaCanvas { background: linear-gradient(145deg, #2d3436, #1d2127); border: 2px solid #00bfff; box-shadow: 0 0 15px rgba(0, 191, 255, 0.6), inset 0 0 8px rgba(0, 191, 255, 0.3); border-radius: 10px; margin-bottom: 20px; width: 300px; height: 200px; display: block; margin-left: auto; margin-right: auto; }
        #captchaStatus { font-size: 15px; font-weight: bold; height: 25px; margin-bottom: 20px; color: #ff9800; }
        .captcha-actions { display: flex; justify-content: center; gap: 15px; margin-top: 10px; }
        .captcha-actions button { background-color: #334155; color: #e0e6f0; padding: 10px 20px; border-radius: 6px; border: 1px solid rgba(0, 191, 255, 0.4); font-size: 15px; transition: all 0.2s ease; }
        .captcha-actions button:hover:not(:disabled) { background-color: #00bfff; color: white; box-shadow: 0 0 10px #00bfff; transform: translateY(-2px); }
        .captcha-actions button:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>
    
    <div id="bot-required-overlay">
        Please Enable ApexBot Extension
        <small style="font-size: 1rem; margin-top: 10px;">(And allow access to file URLs if prompted)</small>
    </div>

    <div id="branchModal" class="modal">
        <div class="modal-content">
            <span class="modal-title">Select Branch</span><span class="close" onclick="closeModal('branchModal')">×</span>
            <div id="branchList" class="branchButtons"></div>
            <button class="next-btn" id="branchModalNextBtn" disabled style="margin-top: 20px;">Next</button>
        </div>
    </div>
    
    <div id="captcha3dModal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <span class="modal-title">3D Security Verification</span>
            <p>หมุนภาพตัวละครให้หันหน้าเข้าหาตัวเอง</p>
            <p class="sub-instruction">ใช้เมาส์หมุนมุมมองรูปภาพตัวละครด้านหน้าจะหันเข้าหาคุณโดยตรง ภาพจะสว่างขึ้นเมื่อวางแนวถูกต้องที่ความแม่นยำ 95%</p>
            <canvas id="captchaCanvas" width="300" height="200" style="cursor: grab;"></canvas>
            <p id="captchaStatus" style="height: 20px;"></p>
            <div class="captcha-actions">
                <button id="retryCaptchaBtn">C ลองอีกครั้ง</button>
                <button id="langToggleBtn">EN</button>
            </div>
        </div>
    </div>
    
    <div id="datetimeModal" class="modal">
        <div class="modal-content">
            <span class="modal-title">Select Date & Time</span><span class="close" onclick="closeModal('datetimeModal')">×</span>
            <div id="dateList"></div>
            <div id="timeList"></div>
            <div class="datePicketButSection" style="margin-top: 20px;">
                <button class="next-btn Next" id="dateTimeNextBtn" disabled>Next</button>
            </div>
        </div>
    </div>
    
    <div class="main-container" style="display: none;">
        </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <script>
        const selections = { branch: null, date: null, time: null };
        let startTime;
        let iconImage; 

        function showPage(pageId) { document.querySelectorAll('#step-area .page').forEach(p => p.classList.remove('active')); document.getElementById(pageId)?.classList.add('active'); }
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        function launchConfetti() { if (typeof confetti !== 'function') return; const end = Date.now() + (2 * 1000); (function frame() { confetti({ particleCount: 3, angle: 60, spread: 55, origin: { x: 0 } }); confetti({ particleCount: 3, angle: 120, spread: 55, origin: { x: 1 } }); if (Date.now() < end) requestAnimationFrame(frame); }()); }
        function handleSuccess() { showPage('page-success'); const endTime = new Date(); const elapsedTime = ((endTime - startTime) / 1000).toFixed(2); document.getElementById('final-summary-branch').textContent = selections.branch; document.getElementById('final-summary-date').textContent = selections.date; document.getElementById('final-summary-time').textContent = selections.time; document.getElementById('final-summary-time-taken').textContent = elapsedTime; launchConfetti(); }
        function resetFlow() { Object.keys(selections).forEach(key => selections[key] = null); showPage('page-register'); startCountdown(); }
        function handleTermsPage() { showPage('page-terms'); const checkbox = document.querySelector("input[name='acceptTermsAndConditions']"); const nextBtn = document.getElementById("finalConfirm"); const cloudflareSim = document.getElementById("cloudflare-simulation"); nextBtn.disabled = true; checkbox.checked = false; cloudflareSim.style.display = 'none'; checkbox.onchange = () => { if (checkbox.checked) { nextBtn.disabled = true; cloudflareSim.style.display = 'flex'; setTimeout(() => { cloudflareSim.style.display = 'none'; if (checkbox.checked) { nextBtn.disabled = false; } }, 2500); } else { nextBtn.disabled = true; } }; }
        function startCountdown() { const countdownEl = document.getElementById("countdown"); const registerBtn = document.getElementById("registerBtn"); let secondsLeft = 7; registerBtn.disabled = true; registerBtn.classList.remove('enabled'); const timer = setInterval(() => { if (secondsLeft <= 0) { clearInterval(timer); countdownEl.textContent = "OPEN!"; registerBtn.disabled = false; registerBtn.classList.add('enabled'); } else { countdownEl.textContent = `00:00:0${secondsLeft--}`; } }, 1000); }

        function openBranchModal() {
            startTime = new Date();
            const modal = document.getElementById("branchModal");
            const nextBtn = document.getElementById("branchModalNextBtn");
            const list = modal.querySelector("#branchList");
            modal.style.display = "flex";
            nextBtn.disabled = true;
            list.innerHTML = "";
            const branches = ["Terminal 21", "Central Ladprao", "Siam Center", "Fashion Island", "Centralworld", "MEGABANGNA", "Siam Square", "Emsphere", "Central Pattaya", "Seacon Square", "Central Westgate", "Central Chiangmai", "ICONSIAM"];
            const unavailableBranches = []; 
            const numUnavailable = Math.floor(Math.random() * 3);
            const shuffledBranches = [...branches].sort(() => 0.5 - Math.random());
            for (let i = 0; i < numUnavailable; i++) { unavailableBranches.push(shuffledBranches[i]); }
            branches.forEach(b => {
                const button = document.createElement("button");
                button.className = "branch-item";
                button.textContent = b;
                if (unavailableBranches.includes(b)) { button.classList.add("is_full"); button.disabled = true; } else {
                    button.onclick = () => {
                        list.querySelectorAll(".branch-item.selected").forEach(el => el.classList.remove("selected"));
                        button.classList.add("selected");
                        selections.branch = b;
                        nextBtn.disabled = false;
                    };
                }
                list.appendChild(button);
            });
            nextBtn.onclick = () => {
                if (selections.branch) {
                    modal.style.display = "none";
                    if (window.AwsWafCaptcha && typeof window.AwsWafCaptcha.renderCaptcha === 'function') {
                        console.log("Bypass Mode DETECTED! Skipping 3D Captcha.");
                        openDateTimeModal();
                    } else {
                        console.log("Normal Mode DETECTED. Opening 3D Captcha.");
                        openCaptcha3dModal();
                    }
                }
            };
        }

        function openCaptcha3dModal() {
            const modal = document.getElementById("captcha3dModal");
            const canvas = document.getElementById("captchaCanvas");
            const status = document.getElementById("captchaStatus");
            const retryBtn = document.getElementById("retryCaptchaBtn");
            const ctx = canvas.getContext('2d');
            
            let isDragging = false, rotationX = 0, rotationY = 0, lastMouseX = 0, lastMouseY = 0;
            const targetRotationX = 0, targetRotationY = 0;
            const rotationThreshold = 0.95; 
            const rotationSensitivity = 0.01;

            if (!iconImage) {
                iconImage = new Image();
                iconImage.src = 'icon.png';
                iconImage.onload = resetCaptcha;
                iconImage.onerror = () => { iconImage = null; resetCaptcha(); };
            } else {
                resetCaptcha();
            }

            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#2d3436';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.save();
                ctx.translate(canvas.width / 2, canvas.height / 2);

                const diffX = Math.abs(rotationX - targetRotationX);
                const diffY = Math.abs(rotationY - targetRotationY);
                const progress = 1 - Math.min((diffX + diffY) / (Math.PI), 1);
                const opacity = 0.2 + (progress * 0.8);

                const perspective = 300;
                const z = perspective - Math.sin(rotationX) * 100;
                const scale = z / perspective;
                
                ctx.transform(scale, 0, 0, scale, 0, 0);
                ctx.rotate(rotationY); 
                
                if (Math.abs(rotationY % (2*Math.PI)) > Math.PI / 2 && Math.abs(rotationY % (2*Math.PI)) < 3 * Math.PI / 2) {
                    ctx.save();
                    ctx.scale(-1, 1);
                    ctx.font = '20px Roboto Mono';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = `rgba(150, 150, 150, 0.7)`;
                    ctx.fillText('ApexBot', 0, 0);
                    ctx.restore();
                } else {
                    if (iconImage) {
                        const imgSize = Math.min(canvas.width, canvas.height) * 0.7;
                        ctx.globalAlpha = opacity;
                        const tiltY = Math.sin(rotationX) * 30; 
                        ctx.drawImage(iconImage, -imgSize / 2, -imgSize / 2 + tiltY, imgSize, imgSize);
                        ctx.globalAlpha = 1;
                    }
                }
                ctx.restore();
            };
            
            function checkCompletion() {
                const diffX = Math.abs(rotationX - targetRotationX);
                const diffY = Math.abs(rotationY - targetRotationY);
                const totalDiff = (diffX + diffY) / 2;
                const thresholdRad = (1 - rotationThreshold) * (Math.PI / 4);
                return totalDiff < thresholdRad;
            };

            function resetCaptcha() {
                isDragging = false;
                rotationX = 0; rotationY = 0;
                status.textContent = "ลากเมาส์บนรูปภาพเพื่อหมุน";
                status.style.color = 'var(--text-muted)';
                draw();
            };

            canvas.onmousedown = (e) => {
                isDragging = true;
                lastMouseX = e.clientX;
                lastMouseY = e.clientY;
                canvas.style.cursor = 'grabbing';
            };
            canvas.onmouseup = () => {
                if (isDragging) {
                    canvas.style.cursor = 'grab';
                    if (checkCompletion()) {
                        status.textContent = "รอ 2 วินาที...";
                        status.style.color = 'var(--accent-green)';
                        draw();
                        setTimeout(() => {
                            closeModal('captcha3dModal');
                            openDateTimeModal();
                        }, 2000);
                    } else {
                        status.textContent = "Incorrect. Please try again.";
                        status.style.color = 'var(--accent-danger)';
                        setTimeout(resetCaptcha, 1500);
                    }
                }
                isDragging = false;
            };
            canvas.onmousemove = (e) => {
                if (isDragging) {
                    const deltaX = e.clientX - lastMouseX;
                    const deltaY = e.clientY - lastMouseY;
                    rotationY += deltaX * rotationSensitivity;
                    rotationX -= deltaY * rotationSensitivity;
                    lastMouseX = e.clientX;
                    lastMouseY = e.clientY;
                    draw();
                }
            };
            canvas.onmouseleave = () => { if(isDragging) canvas.onmouseup(); };
            retryBtn.onclick = resetCaptcha;
            modal.style.display = "flex";
            if (iconImage && iconImage.complete) { resetCaptcha(); }
        }

        function openDateTimeModal() { /* ... โค้ดส่วนนี้เหมือนเดิม ... */ }
        
        function initializePage() {
            const checkBot = () => {
                if (document.body.dataset.dpbotEnabled === 'true') {
                    document.querySelector('.main-container').style.display = 'flex';
                    document.getElementById('bot-required-overlay').style.display = 'none';
                    resetFlow();
                } else {
                    document.getElementById('bot-required-overlay').style.display = 'flex';
                    document.querySelector('.main-container').style.display = 'none';
                }
            };
            setTimeout(checkBot, 200);
        }

        document.getElementById("registerBtn").addEventListener("click", openBranchModal);
        document.getElementById("finalConfirm").addEventListener("click", handleSuccess);
        document.getElementById("resetBtn").addEventListener("click", resetFlow);
        document.addEventListener("DOMContentLoaded", initializePage);
    </script>
</body>
</html>